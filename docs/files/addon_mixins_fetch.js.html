<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/mixins/fetch.js - Ember JSON API Resources</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Ember JSON API Resources" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AdapterApiHostProxyMixin.html">AdapterApiHostProxyMixin</a></li>
                                <li><a href="../classes/ApplicationAdapter.html">ApplicationAdapter</a></li>
                                <li><a href="../classes/ApplicationSerializer.html">ApplicationSerializer</a></li>
                                <li><a href="../classes/AuthorizationMixin.html">AuthorizationMixin</a></li>
                                <li><a href="../classes/ClientError.html">ClientError</a></li>
                                <li><a href="../classes/FetchError.html">FetchError</a></li>
                                <li><a href="../classes/FetchMixin.html">FetchMixin</a></li>
                                <li><a href="../classes/RelatedProxyUtil.html">RelatedProxyUtil</a></li>
                                <li><a href="../classes/Resource.html">Resource</a></li>
                                <li><a href="../classes/ResourceOperationsMixin.html">ResourceOperationsMixin</a></li>
                                <li><a href="../classes/ServerError.html">ServerError</a></li>
                                <li><a href="../classes/ServiceCacheMixin.html">ServiceCacheMixin</a></li>
                                <li><a href="../classes/StoreService.html">StoreService</a></li>
                                <li><a href="../classes/TransformDateAttribute.html">TransformDateAttribute</a></li>
                                <li><a href="../classes/TransformMap.html">TransformMap</a></li>
                                <li><a href="../classes/TransformsMixin.html">TransformsMixin</a></li>
                                <li><a href="../classes/Utils.html">Utils</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/adapter-api-host-proxy-mixin.html">adapter-api-host-proxy-mixin</a></li>
                                <li><a href="../modules/adapters.html">adapters</a></li>
                                <li><a href="../modules/authorization.html">authorization</a></li>
                                <li><a href="../modules/cache.html">cache</a></li>
                                <li><a href="../modules/ember-jsonapi-resources.html">ember-jsonapi-resources</a></li>
                                <li><a href="../modules/fetch.html">fetch</a></li>
                                <li><a href="../modules/initializers.html">initializers</a></li>
                                <li><a href="../modules/resource.html">resource</a></li>
                                <li><a href="../modules/resource-operations.html">resource-operations</a></li>
                                <li><a href="../modules/serializers.html">serializers</a></li>
                                <li><a href="../modules/store.html">store</a></li>
                                <li><a href="../modules/transforms.html">transforms</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: addon/mixins/fetch.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  @module ember-jsonapi-resources
  @submodule fetch
**/
import Ember from &#x27;ember&#x27;;
import RSVP from &#x27;rsvp&#x27;;
import { ServerError, ClientError, FetchError } from &#x27;ember-jsonapi-resources/utils/errors&#x27;;

/**
  Fetch/Ajax methods for use with an Adapter calls &#x60;cacheUpdate&#x60;, &#x60;cacheResource&#x60;
  methods and a &#x60;serializer&#x60; injection.

  @class FetchMixin
  @static
*/
export default Ember.Mixin.create({
  /**
    Flag indicates whether to use window.fetch or not, computed from &#x60;useAjax&#x60;

    @property useFetch
    @type Boolean
  */
  useFetch: Ember.computed(&#x27;useAjax&#x27;, function () {
    let notFirefox = window.navigator.userAgent.indexOf(&quot;Firefox&quot;) === -1;
    return !this.get(&#x27;useAjax&#x27;) &amp;&amp; window.fetch &amp;&amp; notFirefox;
  }),

  /**
    Flag to use $.ajax instead of window.fetch

    @property useAjax
    @type Boolean
  */
  useAjax: false,

  /**
    Makes a fetch request via Fetch API (may use polyfill)

    See http://updates.html5rocks.com/2015/03/introduction-to-fetch

    @private
    @method _fetch
    @param {String} url
    @param {Object} options - May include a query object or an update flag
    @param {Boolean} isUpdate
    @return {Promise}
  */
  _fetch(url, options, isUpdate) {
    return new RSVP.Promise(function(resolve, reject) {
      window.fetch(url, options).then(function(response) {
        if (response.status &gt;= 500) {
          this.fetchServerErrorHandler(response, reject);
        } else if (response.status &gt;= 400) {
          this.fetchClientErrorHandler(response, reject);
        } else if (response.status === 204) {
          this.fetchNoContentHandler(response, resolve);
        } else {
          return this.fetchSuccessHandler(response, resolve, isUpdate);
        }
      }.bind(this)).catch(function(error) {
        this.fetchErrorHandler(error, reject);
      }.bind(this));
    }.bind(this));
  },

  /**
    Fetch server error handler ~ status &gt;= 500

    @method fetchServerErrorHandler
    @param {Response} response - Fetch response
    @param {Function} reject - Promise reject handler
  */
  fetchServerErrorHandler(response, reject) {
    response.text().then(function(respText) {
      let msg = parseFetchErrorMessage(response);
      let json = parseFetchErrorText(respText, response);
      reject(new ServerError(msg, json));
    });
  },

  /**
    Fetch client error handler ~ status &gt;= 400

    @method fetchClientErrorHandler
    @param {Response} response - Fetch response
    @param {Function} reject - Promise reject handler
  */
  fetchClientErrorHandler(response, reject) {
    response.text().then(function(respText) {
      let msg = parseFetchErrorMessage(response);
      let json = parseFetchErrorText(respText, response);
      reject(new ClientError(msg, json));
    });
  },

  /**
    Fetch generic error handler

    @method fetchErrorHandler
    @param {Error|Response} error - Fetch error or response object
    @param {Function} reject - Promise reject handler
  */
  fetchErrorHandler(error, reject) {
    let msg = &#x27;Unable to Fetch resource(s)&#x27;;
    if (error instanceof Error) {
      msg = (error &amp;&amp; error.message) ? error.message : msg;
      reject(new FetchError(msg, error));
    } else if (typeof error.text === &#x27;function&#x27;) {
      error.text().then(function(respText) {
        msg = parseFetchErrorMessage(error);
        reject(new FetchError(msg, parseFetchErrorText(respText, error)));
      });
    } else {
      reject(new FetchError(msg, error));
    }
  },

  /**
    Fetch 204 No Content handler

    @method fetchNoContentHandler
    @param {Response} response - Fetch response
    @param {Function} resolve - Promise resolve handler
  */
  fetchNoContentHandler(response, resolve) {
    return response.text().then(function(resp) {
      resolve(resp || &#x27;&#x27;);
    });
  },

  /**
    Fetch 20x Success handler

    @method fetchSuccessHandler
    @param {Response} response - Fetch response
    @param {Function} resolve - Promise resolve handler
    @param {Boolean} isUpdate - Used with patch to update a resource
  */
  fetchSuccessHandler(response, resolve, isUpdate) {
    return response.json().then(function(json) {
      if (json.data === null) {
        resolve(null);
      } else if (isUpdate) {
        json.data = this.serializer.transformAttributes(json.data);
        this.cacheUpdate({ meta: json.meta, data: json.data, headers: response.headers });
        resolve(json.data);
      } else {
        let resource = this.serializer.deserialize(json);
        this.cacheResource({ meta: json.meta, data: resource, headers: response.headers });
        this.serializer.deserializeIncluded(json.included, { headers: response.headers });
        resolve(resource);
      }
    }.bind(this));
  },

  /**
    Makes an XHR request via $.ajax

    @private
    @method _ajax
    @param {String} url
    @param {Object} options - may include a query object or an update flag
    @param {Boolean} isUpdate
    @return {Promise}
    @requires jQuery
  */
  _ajax(url, options, isUpdate) {
    options.data = options.body;
    delete options.body;
    return new RSVP.Promise(function(resolve, reject) {
      Ember.$.ajax(url, options)
        .done(this.ajaxDoneHandler(resolve, isUpdate))
        .fail(this.ajaxFailHandler(reject));
    }.bind(this));
  },

  /**
    @method ajaxFailHandler
    @param {Function} reject - Promise reject handler
    @return {Function} closure with reject handler
  */
  ajaxFailHandler(reject) {
    let _reject = reject;
    /*
      @param {Object} jqXHR
      @param {String} textStatus
      @param {String} errorThrown
    */
    return function(jqXHR, textStatus, errorThrown) {
      if (jqXHR.status &gt;= 500) {
        this.ajaxServerErrorHandler(jqXHR, textStatus, errorThrown, _reject);
      } else if (jqXHR.status &gt;= 400) {
        this.ajaxClientErrorHandler(jqXHR, textStatus, errorThrown, _reject);
      } else {
        this.ajaxErrorHandler(jqXHR, textStatus, errorThrown, _reject);
      }
    }.bind(this);
  },

  /**
    @method ajaxDoneHandler
    @param {Function} resolve - Promise resolve handler
    @param {Boolean} isUpdate - Used with patch to update a resource
    @return {Function} closure with resolve handler
  */
  ajaxDoneHandler(resolve, isUpdate) {
    let _resolve = resolve, _isUpdate = isUpdate;
    /*
      @param {Object} json - payload
      @param {String} textStatus
      @param {jqXHR} jqXHR
    */
    return function(json, textStatus, jqXHR) {
      if (jqXHR.status === 204) {
        this.ajaxNoContentHandler(json, textStatus, jqXHR, _resolve);
      } else {
        this.ajaxSuccessHandler(json, textStatus, jqXHR, _resolve, _isUpdate);
      }
    }.bind(this);
  },

  /**
    Ajax server error handler ~ status &gt;= 500

    @method ajaxServerErrorHandler
    @param {Object} jqXHR
    @param {String} textStatus
    @param {String} errorThrown
    @param {Function} reject - Promise reject handler
  */
  ajaxServerErrorHandler(jqXHR, textStatus, errorThrown, reject) {
    let msg = &#x27;The Service responded with &#x27; + textStatus + &#x27; &#x27; + jqXHR.status;
    let json = parseXhrErrorResponse(jqXHR, errorThrown);
    reject(new ServerError(msg, json));
  },

  /**
    Ajax client error handler ~ status &gt;= 400

    @method ajaxClientErrorHandler
    @param {Object} jqXHR
    @param {String} textStatus
    @param {String} errorThrown
    @param {Function} reject - Promise reject handler
  */
  ajaxClientErrorHandler(jqXHR, textStatus, errorThrown, reject) {
    let msg = &#x27;The API responded with a &#x27;+ jqXHR.status +&#x27; error.&#x27;;
    let json = parseXhrErrorResponse(jqXHR, errorThrown);
    reject(new ClientError(msg, json));
  },

  /**
    Ajax Generic error handler

    @method ajaxErrorHandler
    @param {Object} jqXHR
    @param {String} textStatus
    @param {String} errorThrown
    @param {Function} reject - Promise reject handler
  */
  ajaxErrorHandler(jqXHR, textStatus, errorThrown, reject) {
    let msg = (errorThrown) ? errorThrown : &#x27;Unable to Fetch resource(s)&#x27;;
    let json = parseXhrErrorResponse(jqXHR, errorThrown);
    reject(new FetchError(msg, json));
  },

  /**
    Ajax 204 No Content handler

    @method ajaxNoContentHandler
    @param {Object} json - payload should be empty
    @param {String} textStatus
    @param {jqXHR} jqXHR
    @param {Function} resolve - Promise resolve handler
  */
  ajaxNoContentHandler(json, textStatus, jqXHR, resolve) {
    resolve(json || &#x27;&#x27;);
  },

  /**
    Ajax 20x Success handler

    @method ajaxSuccessHandler
    @param {Object} json - payload
    @param {String} textStatus
    @param {jqXHR} jqXHR
    @param {Function} resolve - Promise resolve handler
    @param {Boolean} isUpdate - Used with patch to update a resource
  */
  ajaxSuccessHandler(json, textStatus, jqXHR, resolve, isUpdate) {
    if (json.data === null) {
      resolve(null);
      return;
    }
    let headers = this._getAjaxHeaders(jqXHR);
    if (isUpdate) {
      json.data = this.serializer.transformAttributes(json.data);
      this.cacheUpdate({ meta: json.meta, data: json.data, headers: headers });
      resolve(json.data);
    } else {
      let resource = this.serializer.deserialize(json);
      this.cacheResource({ meta: json.meta, data: resource, headers: headers });
      this.serializer.deserializeIncluded(json.included, { headers: headers });
      resolve(resource);
    }
  },

  /**
    @private
    @method _getXHRHeaders
    @param {Object} jqXHR
    @return {Object}
  */
  _getAjaxHeaders(jqXHR) {
    let headers = jqXHR.getAllResponseHeaders();
    headers = headers.split(&#x27;\n&#x27;);
    let headersDictionary = {}, key, value, header;
    for (let i = 0; i &lt; headers.length; i++) {
      header = headers[i].split(&#x27;: &#x27;);
      if (header[0].trim() !== &#x27;&#x27;) {
        key = header[0].trim();
        value = header[1].trim();
        headersDictionary[key] = value;
      }
    }
    return headersDictionary;
  }

});

function parseFetchErrorMessage(response) {
  return [
    &#x27;The API responded with a &#x27;,
    response.status,
    (response.statusText) ? &#x27; (&#x27; + response.statusText + &#x27;) &#x27; : &#x27;&#x27;,
    &#x27; error.&#x27;
  ].join(&#x27;&#x27;);
}

function parseFetchErrorText(text, response) {
  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    Ember.Logger.warn(err);
    json = {
      &quot;errors&quot;: [{
        &quot;status&quot;: response.status,
        &quot;detail&quot;: text
      }]
    };
  }
  json = json || {};
  json.status = response.status;
  return json;
}

function parseXhrErrorResponse(jqXHR, errorThrown) {
  let json = jqXHR.responseJSON;
  if (!json) {
    try {
      if (jqXHR.responseText) {
        json = JSON.parse(jqXHR.responseText);
      }
    } catch(err) {
      Ember.Logger.warn(err);
    }
  }
  json = json || {};
  json.status = jqXHR.status;
  json.errors = json.errors || [{
    status: jqXHR.status,
    detail: jqXHR.responseText,
    message: errorThrown
  }];
  return json;
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
